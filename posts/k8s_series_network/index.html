<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    
      <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;">

    

    <meta name="author" content="Hello.CC">
    <meta name="description" content="ç½‘ç»œ">
    <meta name="keywords" content="blog,developer,personal,writer">

    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://cctrip.github.io/posts/k8s_series_network/k8s-image.jpg"/>
<meta name="twitter:title" content="Kubernetesç³»åˆ—ï¼šç½‘ç»œ"/>
<meta name="twitter:description" content="ç½‘ç»œ"/>

    <meta property="og:title" content="Kubernetesç³»åˆ—ï¼šç½‘ç»œ" />
<meta property="og:description" content="ç½‘ç»œ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cctrip.github.io/posts/k8s_series_network/" /><meta property="og:image" content="https://cctrip.github.io/posts/k8s_series_network/k8s-image.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-30T17:55:28&#43;08:00" />
<meta property="article:modified_time" content="2020-10-30T17:55:28&#43;08:00" />



    <title>
  Kubernetesç³»åˆ—ï¼šç½‘ç»œ Â· CC&#39;s Trip
</title>

    
      <link rel="canonical" href="https://cctrip.github.io/posts/k8s_series_network/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.543dc3579b222ee2eec7bc52e75060428d931ade1c0263624cf4be95f0f467a2.css" integrity="sha256-VD3DV5siLuLux7xS51BgQo2TGt4cAmNiTPS&#43;lfD0Z6I=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.92eafdad7963af697840da26de3829cd3610aa623b917f6c37fb3f81e404b693.css" integrity="sha256-kur9rXljr2l4QNom3jgpzTYQqmI7kX9sN/s/geQEtpM=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/leo.png" sizes="32x32">
    

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.81.0" />
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto">
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      CC&#39;s Trip
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/contact/">Contact me</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://cctrip.github.io/zh-cn/">ğŸ‡¨ğŸ‡³</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://cctrip.github.io/posts/k8s_series_network/">
              Kubernetesç³»åˆ—ï¼šç½‘ç»œ
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2020-10-30T17:55:28&#43;08:00'>
                October 30, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              5-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa fa-folder" aria-hidden="true"></i>
    <a href="/categories/cloud-native/">Cloud Native</a></div>

          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/kubernetes/">kubernetes</a>
    </span></div>

        </div>
      </header>

      <div>
        
        <h2 id="ç³»åˆ—ç›®å½•">
  ç³»åˆ—ç›®å½•
  <a class="heading-link" href="#%e7%b3%bb%e5%88%97%e7%9b%ae%e5%bd%95">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p><a href="../k8s_series">ã€ŠKubernetesç³»åˆ—ï¼šå¼€ç¯‡ã€‹</a></p>
<p><a href="../k8s_series_intro">ã€ŠKubernetesç³»åˆ—ï¼šæ¦‚è¿°ã€‹</a></p>
<p><a href="../k8s_series_arch">ã€ŠKubernetesç³»åˆ—ï¼šæ¶æ„ã€‹</a></p>
<p><a href="../k8s_series_container">ã€ŠKubernetesç³»åˆ—ï¼šå®¹å™¨ã€‹</a></p>
<p><a href="../k8s_series_network">ã€ŠKubernetesç³»åˆ—ï¼šç½‘ç»œã€‹</a></p>
<p><a href="../k8s_series_storage">ã€ŠKubernetesç³»åˆ—ï¼šå­˜å‚¨ã€‹</a></p>
<p><a href="../k8s_series_service">ã€ŠKubernetesç³»åˆ—ï¼šServiceã€‹</a></p>
<p><a href="../k8s_series_ingress">ã€ŠKubernetesç³»åˆ—ï¼šIngressã€‹</a></p>
<p><a href="../k8s_series_oma">ã€ŠKubernetesç³»åˆ—ï¼šOAMã€‹</a></p>
<hr>
<h2 id="1-ä»‹ç»">
  1. ä»‹ç»
  <a class="heading-link" href="#1-%e4%bb%8b%e7%bb%8d">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>ç½‘ç»œæ˜¯ Kubernetes çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¸è¿‡ï¼ŒKubernetesæœ¬èº«å¹¶ä¸æä¾›ç½‘ç»œåŠŸèƒ½ï¼Œåªæ˜¯æŠŠç½‘ç»œæ¥å£å¼€æ”¾å‡ºæ¥ï¼Œé€šè¿‡æ’ä»¶çš„å½¢å¼å®ç°ã€‚è¿™å°±æ˜¯CNI(Container Network Interface)ã€‚</p>
<blockquote>
<p>CNIï¼ˆContainer Network Interfaceï¼‰æ˜¯ CNCF æ——ä¸‹çš„ä¸€ä¸ªé¡¹ç›®ï¼Œç”±ä¸€ç»„ç”¨äºé…ç½® Linux å®¹å™¨çš„ç½‘ç»œæ¥å£çš„è§„èŒƒå’Œåº“ç»„æˆï¼ŒåŒæ—¶è¿˜åŒ…å«äº†ä¸€äº›æ’ä»¶ã€‚CNI ä»…å…³å¿ƒå®¹å™¨åˆ›å»ºæ—¶çš„ç½‘ç»œåˆ†é…ï¼Œå’Œå½“å®¹å™¨è¢«åˆ é™¤æ—¶é‡Šæ”¾ç½‘ç»œèµ„æºã€‚é€šè¿‡æ­¤é“¾æ¥æµè§ˆè¯¥é¡¹ç›®ï¼šhttps://github.com/containernetworking/cniã€‚</p>
</blockquote>
<p>Kubernetes å¯¹æ‰€æœ‰ç½‘ç»œè®¾æ–½çš„å®æ–½ï¼Œéƒ½éœ€è¦æ»¡è¶³ä»¥ä¸‹çš„åŸºæœ¬è¦æ±‚ï¼š</p>
<ul>
<li>èŠ‚ç‚¹ä¸Šçš„ Pod å¯ä»¥ä¸é€šè¿‡ NAT å’Œå…¶ä»–ä»»ä½•èŠ‚ç‚¹ä¸Šçš„ Pod é€šä¿¡</li>
<li>èŠ‚ç‚¹ä¸Šçš„ä»£ç†(æ¯”å¦‚ï¼šç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ã€kubelet)å¯ä»¥å’ŒèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Podé€šä¿¡</li>
<li>Podè‡ªå·±çš„IPå°±æ˜¯å…¶ä»–äººçœ‹åˆ°çš„IP</li>
</ul>
<p>å› æ­¤ï¼Œä¸€ä¸ªkubernetesç½‘ç»œæ’ä»¶å¿…é¡»è¦è§£å†³ä¸‹é¢äº”ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>Container-to-Container ç½‘ç»œé€šä¿¡</li>
<li>Pod-to-Pod ç½‘ç»œé€šä¿¡</li>
<li>Pod-to-Service ç½‘ç»œé€šä¿¡</li>
<li>Internet-to-Service ç½‘ç»œé€šä¿¡</li>
<li>Pod IPåœ¨é›†ç¾¤å†…å”¯ä¸€</li>
</ol>
<hr>
<h2 id="2-åŸºæœ¬åŸç†">
  2. åŸºæœ¬åŸç†
  <a class="heading-link" href="#2-%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h3 id="21-container-to-container">
  2.1 Container-to-Container
  <a class="heading-link" href="#21-container-to-container">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>åœ¨kubernetesä¸­ï¼Œä¸€ä¸ªPodæ˜¯ä¸€ç»„Containerçš„ç»„åˆï¼Œå¹¶ä¸”ï¼ŒPodå†…çš„Containeræ˜¯å…±äº«network namespaceçš„ï¼Œå› æ­¤è¯¥Podå†…çš„Containerçš„ipå’Œmacåœ°å€éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å®ƒä»¬åªéœ€è¦é€šè¿‡localhostå°±èƒ½è·ŸPodå†…å…¶ä»–Containeré€šä¿¡äº†ï¼Œä¸è¿‡ï¼Œå› ä¸ºæ˜¯å…±äº«network namespaceï¼Œå› æ­¤è¯¥Podå†…çš„ç«¯å£å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½å†²çªã€‚</p>
<p><img src="c-to-c.png" alt=""></p>
<hr>
<h3 id="22-pod-to-pod">
  2.2 Pod-to-Pod
  <a class="heading-link" href="#22-pod-to-pod">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>åœ¨å®¹å™¨ä¸­ï¼Œå®¹å™¨å¯ä»¥é€šè¿‡network namespaceçš„æŠ€æœ¯å°†ä¸åŒçš„å®¹å™¨çš„ç½‘ç»œéš”ç¦»èµ·æ¥ï¼Œå¹¶é€šè¿‡veth pairæŠ€æœ¯å°†ä¸¤ä¸ªnamespaceè¿æ¥èµ·æ¥ä»¥è¿›è¡Œé€šä¿¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªpodéƒ½æœ‰è‡ªå·±çš„netnsï¼Œé€šè¿‡veth pairè·ŸèŠ‚ç‚¹çš„root netnsè¿æ¥èµ·æ¥ï¼Œè¿™æ ·ä¸€æ¥ï¼Œpodå°±èƒ½ç›´æ¥è·Ÿnodeè¿›è¡Œé€šä¿¡äº†</p>
<p><img src="pod-veth-pairs.png" alt=""></p>
<p>ä½†æ˜¯å‘¢ï¼Œæˆ‘ä»¬åˆå¸Œæœ›pod1è·Ÿpod2è¿›è¡Œé€šä¿¡ï¼Œå› æ­¤ï¼Œåˆéœ€è¦æ·»åŠ é¢å¤–çš„æŠ€æœ¯å…è®¸æ•°æ®åŒ…é€šè¿‡root netnsä¼ å…¥ä¸åŒçš„podçš„netnsä¸­ï¼Œæ¯”å¦‚bridgeæŠ€æœ¯ï¼Œå½“ç„¶ï¼Œä¹Ÿæœ‰äº›å¯ä»¥ç”¨è·¯ç”±è¡¨æ¥å®ç°ã€‚</p>
<p><img src="pods-connected-by-bridge.png" alt=""></p>
<h4 id="221-åŒnode">
  2.2.1 åŒNode
  <a class="heading-link" href="#221-%e5%90%8cnode">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>é€šè¿‡network namespaceã€veth pairå’ŒbridgeæŠ€æœ¯ï¼Œæˆ‘ä»¬å°±èƒ½å®ç°åŒnodeå†…çš„podä¹‹é—´çš„é€šä¿¡äº†ï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªæ•°æ®åŒ…åœ¨ä¸åŒpodä¹‹é—´çš„æµç¨‹å›¾ï¼š</p>
<p><img src="pod-to-pod-same-node.gif" alt=""></p>
<ul>
<li>pod1å°†æ•°æ®åŒ…é€šè¿‡è‡ªå·±çš„eth0è®¾å¤‡å‘é€åˆ°root namespaceçš„veth0ä¸Š</li>
<li>veth0å°†æ•°æ®åŒ…è½¬å‘ç»™cbr0 ç½‘æ¡¥è®¾å¤‡</li>
<li>ç½‘æ¡¥è®¾å¤‡è§£ææ­£ç¡®çš„ç½‘æ®µï¼Œä½¿ç”¨ARPåè®®å°†æ•°æ®åŒ…å‘é€åˆ°veth1</li>
<li>veth1å°†æ•°æ®åŒ…è½¬å‘ç»™pod2çš„namespaceä¸­çš„eth0è®¾å¤‡ä¸Šï¼Œè¿”å›ä¹Ÿæ˜¯ä¸€æ ·çš„æ“ä½œ</li>
</ul>
<h4 id="222-è·¨node">
  2.2.2 è·¨Node
  <a class="heading-link" href="#222-%e8%b7%a8node">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>é€šå¸¸ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªNodeéƒ½åˆ†é…æœ‰ä¸€ä¸ªCIDRå—ï¼Œè¯¥CIRDå—æŒ‡å®šäº†è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„Podå¯ç”¨çš„IPåœ°å€ã€‚ä¸€æ—¦å‘å¾€CIDRå—çš„æµé‡åˆ°è¾¾Nodeï¼Œåˆ™Nodeæœ‰è´£ä»»å°†æµé‡è½¬å‘åˆ°æ­£ç¡®çš„Podä¸Šã€‚åœ¨è·¨Nodeçš„Podä¸Šï¼Œè¿™é‡Œå°±éœ€è¦CNIæ’ä»¶å…·æœ‰çŸ¥é“æ¯ä¸ªPodçš„ipåœ¨å“ªä¸ªnodeä¸Šçš„åŠŸèƒ½ï¼Œå¹¶ä¸”æœ‰èƒ½åŠ›å°†æ•°æ®åŒ…è·¯ç”±åˆ°æ­£ç¡®çš„Nodeä¸Šã€‚</p>
<p><img src="pod-to-pod-different-nodes.gif" alt=""></p>
<ul>
<li>Pod1å°†æ•°æ®åŒ…å‘å¾€eth0ï¼Œé€šè¿‡veth0åˆ°è¾¾äº†root namespace</li>
<li>Node(VM1)é€šè¿‡è·¯ç”±è¡¨ä¿¡æ¯å°†æ•°æ®åŒ…å‘å¾€ç½‘ç»œä¸­</li>
<li>CNIæ’ä»¶çŸ¥é“ç›®æ ‡ipåœ¨å“ªä¸ªNodeä¸Šï¼Œå°†æ•°æ®åŒ…å‘é€ç»™å¯¹åº”çš„Node(VM2)</li>
<li>VM2æ¥æ”¶åˆ°æ•°æ®åŒ…åï¼Œå‘ç°ç›®æ ‡ipåœ¨pod4ä¸Šï¼Œé€šè¿‡veth1å°†æ•°æ®åŒ…å‘é€åˆ°pod4çš„eth0ä¸Š</li>
</ul>
<p>åœ¨åç»­çš„ä¸åŒCNIæ’ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¼šäº†è§£ä¸€ä¸‹å„ä¸ªæ’ä»¶é’ˆå¯¹è·¨Nodeçš„ç½‘ç»œé€šä¿¡çš„å®ç°æœºåˆ¶ã€‚</p>
<hr>
<h3 id="23-pod-to-service-å’Œ-internet-to-service">
  2.3 Pod-to-Service å’Œ Internet-to-Service
  <a class="heading-link" href="#23-pod-to-service-%e5%92%8c-internet-to-service">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>è¿™ä¸ªç½‘ç»œé€šä¿¡å°†åœ¨Serviceç« èŠ‚ä¸­ç»†è¯´ã€‚</p>
<hr>
<h2 id="3-cni">
  3. CNI
  <a class="heading-link" href="#3-cni">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h3 id="31-æ¥å£å®šä¹‰">
  3.1 æ¥å£å®šä¹‰
  <a class="heading-link" href="#31-%e6%8e%a5%e5%8f%a3%e5%ae%9a%e4%b9%89">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>CNI çš„æ¥å£ä¸­åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#268bd2">type</span> CNI <span style="color:#268bd2">interface</span> {<span style="color:#268bd2">AddNetworkList</span> (net <span style="color:#719e07">*</span>NetworkConfigList, rt <span style="color:#719e07">*</span>RuntimeConf) (types.Result, <span style="color:#dc322f">error</span>)
    <span style="color:#268bd2">DelNetworkList</span> (net <span style="color:#719e07">*</span>NetworkConfigList, rt <span style="color:#719e07">*</span>RuntimeConf) <span style="color:#dc322f">error</span>

    <span style="color:#268bd2">AddNetwork</span> (net <span style="color:#719e07">*</span>NetworkConfig, rt <span style="color:#719e07">*</span>RuntimeConf) (types.Result, <span style="color:#dc322f">error</span>)
    <span style="color:#268bd2">DelNetwork</span> (net <span style="color:#719e07">*</span>NetworkConfig, rt <span style="color:#719e07">*</span>RuntimeConf) <span style="color:#dc322f">error</span>
}
</code></pre></div><p>è¯¥æ¥å£åªæœ‰å››ä¸ªæ–¹æ³•ï¼Œæ·»åŠ ç½‘ç»œã€åˆ é™¤ç½‘ç»œã€æ·»åŠ ç½‘ç»œåˆ—è¡¨ã€åˆ é™¤ç½‘ç»œåˆ—è¡¨ã€‚</p>
<h3 id="32-è®¾è®¡è€ƒé‡">
  3.2 è®¾è®¡è€ƒé‡
  <a class="heading-link" href="#32-%e8%ae%be%e8%ae%a1%e8%80%83%e9%87%8f">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>CNI è®¾è®¡çš„æ—¶å€™è€ƒè™‘äº†ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>å®¹å™¨è¿è¡Œæ—¶å¿…é¡»åœ¨è°ƒç”¨ä»»ä½•æ’ä»¶ä¹‹å‰ä¸ºå®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œå‘½åç©ºé—´ã€‚</li>
<li>ç„¶åï¼Œè¿è¡Œæ—¶å¿…é¡»ç¡®å®šè¿™ä¸ªå®¹å™¨åº”å±äºå“ªä¸ªç½‘ç»œï¼Œå¹¶ä¸ºæ¯ä¸ªç½‘ç»œç¡®å®šå“ªäº›æ’ä»¶å¿…é¡»è¢«æ‰§è¡Œã€‚</li>
<li>ç½‘ç»œé…ç½®é‡‡ç”¨ JSON æ ¼å¼ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚ç½‘ç»œé…ç½®åŒ…æ‹¬å¿…å¡«å­—æ®µï¼Œå¦‚ <code>name</code> å’Œ <code>type</code> ä»¥åŠæ’ä»¶ï¼ˆç±»å‹ï¼‰ã€‚ç½‘ç»œé…ç½®å…è®¸å­—æ®µåœ¨è°ƒç”¨ä¹‹é—´æ”¹å˜å€¼ã€‚ä¸ºæ­¤ï¼Œæœ‰ä¸€ä¸ªå¯é€‰çš„å­—æ®µ <code>args</code>ï¼Œå¿…é¡»åŒ…å«ä¸åŒçš„ä¿¡æ¯ã€‚</li>
<li>å®¹å™¨è¿è¡Œæ—¶å¿…é¡»æŒ‰é¡ºåºä¸ºæ¯ä¸ªç½‘ç»œæ‰§è¡Œç›¸åº”çš„æ’ä»¶ï¼Œå°†å®¹å™¨æ·»åŠ åˆ°æ¯ä¸ªç½‘ç»œä¸­ã€‚</li>
<li>åœ¨å®Œæˆå®¹å™¨ç”Ÿå‘½å‘¨æœŸåï¼Œè¿è¡Œæ—¶å¿…é¡»ä»¥ç›¸åçš„é¡ºåºæ‰§è¡Œæ’ä»¶ï¼ˆç›¸å¯¹äºæ‰§è¡Œæ·»åŠ å®¹å™¨çš„é¡ºåºï¼‰ä»¥å°†å®¹å™¨ä¸ç½‘ç»œæ–­å¼€è¿æ¥ã€‚</li>
<li>å®¹å™¨è¿è¡Œæ—¶ä¸èƒ½ä¸ºåŒä¸€å®¹å™¨è°ƒç”¨å¹¶è¡Œæ“ä½œï¼Œä½†å¯ä»¥ä¸ºä¸åŒçš„å®¹å™¨è°ƒç”¨å¹¶è¡Œæ“ä½œã€‚</li>
<li>å®¹å™¨è¿è¡Œæ—¶å¿…é¡»ä¸ºå®¹å™¨è®¢é˜… ADD å’Œ DEL æ“ä½œï¼Œè¿™æ · ADD åé¢æ€»æ˜¯è·Ÿç€ç›¸åº”çš„ DELã€‚ DEL å¯èƒ½è·Ÿç€é¢å¤–çš„ DELï¼Œä½†æ˜¯ï¼Œæ’ä»¶åº”è¯¥å…è®¸å¤„ç†å¤šä¸ª DELï¼ˆå³æ’ä»¶ DEL åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼‰ã€‚</li>
<li>å®¹å™¨å¿…é¡»ç”± ContainerID å”¯ä¸€æ ‡è¯†ã€‚å­˜å‚¨çŠ¶æ€çš„æ’ä»¶åº”è¯¥ä½¿ç”¨ï¼ˆç½‘ç»œåç§°ï¼Œå®¹å™¨ IDï¼‰çš„ä¸»é”®æ¥å®Œæˆã€‚</li>
<li>è¿è¡Œæ—¶ä¸èƒ½è°ƒç”¨åŒä¸€ä¸ªç½‘ç»œåç§°æˆ–å®¹å™¨ ID æ‰§è¡Œä¸¤æ¬¡ ADDï¼ˆæ²¡æœ‰ç›¸åº”çš„ DELï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œç»™å®šçš„å®¹å™¨ ID å¿…é¡»åªèƒ½æ·»åŠ åˆ°ç‰¹å®šçš„ç½‘ç»œä¸€æ¬¡ã€‚</li>
</ul>
<h3 id="33-cni-æ’ä»¶">
  3.3 CNI æ’ä»¶
  <a class="heading-link" href="#33-cni-%e6%8f%92%e4%bb%b6">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>CNI æ’ä»¶å¿…é¡»å®ç°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢«å®¹å™¨ç®¡ç†ç³»ç»Ÿï¼ˆä¾‹å¦‚ rkt æˆ– Kubernetesï¼‰è°ƒç”¨ã€‚</p>
<p>CNI æ’ä»¶è´Ÿè´£å°†ç½‘ç»œæ¥å£æ’å…¥å®¹å™¨ç½‘ç»œå‘½åç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œveth å¯¹çš„ä¸€ç«¯ï¼‰ï¼Œå¹¶åœ¨ä¸»æœºä¸Šè¿›è¡Œä»»ä½•å¿…è¦çš„æ”¹å˜ï¼ˆä¾‹å¦‚å°† veth çš„å¦ä¸€ç«¯è¿æ¥åˆ°ç½‘æ¡¥ï¼‰ã€‚ç„¶åå°† IP åˆ†é…ç»™æ¥å£ï¼Œå¹¶é€šè¿‡è°ƒç”¨é€‚å½“çš„ IPAM æ’ä»¶æ¥è®¾ç½®ä¸ â€œIP åœ°å€ç®¡ç†â€ éƒ¨åˆ†ä¸€è‡´çš„è·¯ç”±ã€‚</p>
<h4 id="331-å‚æ•°">
  3.3.1 å‚æ•°
  <a class="heading-link" href="#331-%e5%8f%82%e6%95%b0">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>CNI æ’ä»¶å¿…é¡»æ”¯æŒä»¥ä¸‹æ“ä½œï¼š</p>
<p><strong>å°†å®¹å™¨æ·»åŠ åˆ°ç½‘ç»œ</strong></p>
<p>å‚æ•°ï¼š</p>
<ul>
<li><strong>ç‰ˆæœ¬</strong>è°ƒç”¨è€…æ­£åœ¨ä½¿ç”¨çš„ CNI è§„èŒƒï¼ˆå®¹å™¨ç®¡ç†ç³»ç»Ÿæˆ–è°ƒç”¨æ’ä»¶ï¼‰çš„ç‰ˆæœ¬ã€‚</li>
<li><strong>å®¹å™¨ ID</strong>ç”±è¿è¡Œæ—¶åˆ†é…çš„å®¹å™¨çš„å”¯ä¸€æ˜æ–‡æ ‡è¯†ç¬¦ã€‚ä¸€å®šä¸èƒ½æ˜¯ç©ºçš„ã€‚</li>
<li><strong>ç½‘ç»œå‘½åç©ºé—´è·¯å¾„</strong>è¦æ·»åŠ çš„ç½‘ç»œåç§°ç©ºé—´çš„è·¯å¾„ï¼Œå³ <code>/proc/[pid]/ns/net</code> æˆ–ç»‘å®šæŒ‚è½½ / é“¾æ¥ã€‚</li>
<li><strong>ç½‘ç»œé…ç½®</strong>æè¿°å®¹å™¨å¯ä»¥åŠ å…¥çš„ç½‘ç»œçš„ JSON æ–‡æ¡£ã€‚æ¶æ„å¦‚ä¸‹æ‰€è¿°ã€‚</li>
<li><strong>é¢å¤–çš„å‚æ•°</strong>è¿™æä¾›äº†ä¸€ä¸ªæ›¿ä»£æœºåˆ¶ï¼Œå…è®¸åœ¨æ¯ä¸ªå®¹å™¨ä¸Šç®€å•é…ç½® CNI æ’ä»¶ã€‚</li>
<li><strong>å®¹å™¨å†…æ¥å£çš„åç§°</strong>è¿™æ˜¯åº”è¯¥åˆ†é…ç»™å®¹å™¨ï¼ˆç½‘ç»œå‘½åç©ºé—´ï¼‰å†…åˆ›å»ºçš„æ¥å£çš„åç§°ï¼›å› æ­¤å®ƒå¿…é¡»ç¬¦åˆ Linux æ¥å£åç§°ä¸Šçš„æ ‡å‡†é™åˆ¶ã€‚</li>
</ul>
<p>ç»“æœï¼š</p>
<ul>
<li><strong>æ¥å£åˆ—è¡¨</strong>æ ¹æ®æ’ä»¶çš„ä¸åŒï¼Œè¿™å¯ä»¥åŒ…æ‹¬æ²™ç®±ï¼ˆä¾‹å¦‚å®¹å™¨æˆ–ç®¡ç†ç¨‹åºï¼‰æ¥å£åç§°å’Œ / æˆ–ä¸»æœºæ¥å£åç§°ï¼Œæ¯ä¸ªæ¥å£çš„ç¡¬ä»¶åœ°å€ä»¥åŠæ¥å£æ‰€åœ¨çš„æ²™ç®±ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li><strong>åˆ†é…ç»™æ¯ä¸ªæ¥å£çš„ IP é…ç½®</strong>åˆ†é…ç»™æ²™ç®±å’Œ / æˆ–ä¸»æœºæ¥å£çš„ IPv4 å’Œ / æˆ– IPv6 åœ°å€ï¼Œç½‘å…³å’Œè·¯ç”±ã€‚</li>
<li><strong>DNS ä¿¡æ¯</strong>åŒ…å« nameserverã€domainã€search domain å’Œ option çš„ DNS ä¿¡æ¯çš„å­—å…¸ã€‚</li>
</ul>
<p><strong>ä»ç½‘ç»œä¸­åˆ é™¤å®¹å™¨</strong></p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>
<p><strong>ç‰ˆæœ¬</strong>è°ƒç”¨è€…æ­£åœ¨ä½¿ç”¨çš„ CNI è§„èŒƒï¼ˆå®¹å™¨ç®¡ç†ç³»ç»Ÿæˆ–è°ƒç”¨æ’ä»¶ï¼‰çš„ç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p><strong>å®¹å™¨ ID</strong>ï¼Œå¦‚ä¸Šæ‰€è¿°ã€‚</p>
</li>
<li>
<p><strong>ç½‘ç»œå‘½åç©ºé—´è·¯å¾„</strong>ï¼Œå¦‚ä¸Šå®šä¹‰ã€‚</p>
</li>
<li>
<p><strong>ç½‘ç»œé…ç½®</strong>ï¼Œå¦‚ä¸Šæ‰€è¿°ã€‚</p>
</li>
<li>
<p><strong>é¢å¤–çš„å‚æ•°</strong>ï¼Œå¦‚ä¸Šæ‰€è¿°ã€‚</p>
</li>
<li>
<p><strong>ä¸Šé¢å®šä¹‰çš„å®¹å™¨</strong>å†…çš„æ¥å£çš„åç§°ã€‚</p>
</li>
<li>
<p>æ‰€æœ‰å‚æ•°åº”ä¸ä¼ é€’ç»™ç›¸åº”çš„æ·»åŠ æ“ä½œçš„å‚æ•°ç›¸åŒã€‚</p>
</li>
<li>
<p>åˆ é™¤æ“ä½œåº”é‡Šæ”¾é…ç½®çš„ç½‘ç»œä¸­æä¾›çš„ containerid æ‹¥æœ‰çš„æ‰€æœ‰èµ„æºã€‚</p>
</li>
</ul>
<p>æŠ¥å‘Šç‰ˆæœ¬</p>
<ul>
<li>å‚æ•°ï¼šæ— ã€‚</li>
<li>ç»“æœï¼šæ’ä»¶æ”¯æŒçš„ CNI è§„èŒƒç‰ˆæœ¬ä¿¡æ¯ã€‚</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{â€œcniVersionâ€ï¼šâ€œ0.3.1â€ï¼Œ// æ­¤è¾“å‡ºä½¿ç”¨çš„ CNI è§„èŒƒçš„ç‰ˆæœ¬
â€œsupportedVersionsâ€ï¼š[â€œ0.1.0â€ï¼Œâ€œ0.2.0â€ï¼Œâ€œ0.3.0â€ï¼Œâ€œ0.3.1â€] // æ­¤æ’ä»¶æ”¯æŒçš„ CNI è§„èŒƒç‰ˆæœ¬åˆ—è¡¨
}
</code></pre></div><p>CNI æ’ä»¶çš„è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š<a href="https://github.com/containernetworking/cni/blob/master/SPEC.md">CNI SPEC</a>ã€‚</p>
<h4 id="332-ip-åˆ†é…">
  3.3.2 IP åˆ†é…
  <a class="heading-link" href="#332-ip-%e5%88%86%e9%85%8d">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>ä½œä¸ºå®¹å™¨ç½‘ç»œç®¡ç†çš„ä¸€éƒ¨åˆ†ï¼ŒCNI æ’ä»¶éœ€è¦ä¸ºæ¥å£åˆ†é…ï¼ˆå¹¶ç»´æŠ¤ï¼‰IP åœ°å€ï¼Œå¹¶å®‰è£…ä¸è¯¥æ¥å£ç›¸å…³çš„æ‰€æœ‰å¿…è¦è·¯ç”±ã€‚è¿™ç»™äº† CNI æ’ä»¶å¾ˆå¤§çš„çµæ´»æ€§ï¼Œä½†ä¹Ÿç»™å®ƒå¸¦æ¥äº†å¾ˆå¤§çš„è´Ÿæ‹…ã€‚ä¼—å¤šçš„ CNI æ’ä»¶éœ€è¦ç¼–å†™ç›¸åŒçš„ä»£ç æ¥æ”¯æŒç”¨æˆ·éœ€è¦çš„å¤šç§ IP ç®¡ç†æ–¹æ¡ˆï¼ˆä¾‹å¦‚ dhcpã€host-localï¼‰ã€‚</p>
<p>ä¸ºäº†å‡è½»è´Ÿæ‹…ï¼Œä½¿ IP ç®¡ç†ç­–ç•¥ä¸ CNI æ’ä»¶ç±»å‹è§£è€¦ï¼Œæˆ‘ä»¬å®šä¹‰äº† IP åœ°å€ç®¡ç†æ’ä»¶ï¼ˆIPAM æ’ä»¶ï¼‰ã€‚CNI æ’ä»¶çš„èŒè´£æ˜¯åœ¨æ‰§è¡Œæ—¶æ°å½“åœ°è°ƒç”¨ IPAM æ’ä»¶ã€‚ IPAM æ’ä»¶å¿…é¡»ç¡®å®šæ¥å£ IP/subnetï¼Œç½‘å…³å’Œè·¯ç”±ï¼Œå¹¶å°†æ­¤ä¿¡æ¯è¿”å›åˆ° â€œä¸»â€ æ’ä»¶æ¥åº”ç”¨é…ç½®ã€‚ IPAM æ’ä»¶å¯ä»¥é€šè¿‡åè®®ï¼ˆä¾‹å¦‚ dhcpï¼‰ã€å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ•°æ®ã€ç½‘ç»œé…ç½®æ–‡ä»¶çš„ â€œipamâ€ éƒ¨åˆ†æˆ–ä¸Šè¿°çš„ç»„åˆæ¥è·å¾—ä¿¡æ¯ã€‚</p>
<hr>
<h2 id="4-ä¸»æµæ–¹æ¡ˆ">
  4. ä¸»æµæ–¹æ¡ˆ
  <a class="heading-link" href="#4-%e4%b8%bb%e6%b5%81%e6%96%b9%e6%a1%88">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<ul>
<li>flannel</li>
<li>calico</li>
<li>cilium</li>
<li>äº‘å‚å•†(VPC)</li>
</ul>
<p>å› ä¸ºæˆ‘è‡ªå·±æ¥è§¦çš„æ˜¯é€šè¿‡åŸºäºAWSçš„EKSå®ç°çš„kubernetesé›†ç¾¤ï¼Œå› æ­¤å…ˆè¯´ä¸‹awsçš„CNIæ’ä»¶æ–¹æ¡ˆ</p>
<hr>
<h3 id="41-amazon-vpc-cni-k8s">
  4.1 amazon-vpc-cni-k8s
  <a class="heading-link" href="#41-amazon-vpc-cni-k8s">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<h4 id="411-k8sè¿è¡Œåœ¨aws-vpcä¸Šçš„ç›®æ ‡">
  4.1.1 K8Sè¿è¡Œåœ¨AWS VPCä¸Šçš„ç›®æ ‡
  <a class="heading-link" href="#411-k8s%e8%bf%90%e8%a1%8c%e5%9c%a8aws-vpc%e4%b8%8a%e7%9a%84%e7%9b%ae%e6%a0%87">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<ul>
<li>Podè”ç½‘å¿…é¡»æ”¯æŒä¸ç”¨æˆ·ä»EC2è”ç½‘ä¸­è·å¾—çš„ç‰¹æ€§ç›¸å½“çš„é«˜ååé‡å’Œå¯ç”¨æ€§ï¼Œä½å»¶è¿Ÿå’Œæœ€å°æŠ–åŠ¨</li>
<li>å¯ä»¥ä½¿ç”¨è·ŸEC2ä¸€æ ·çš„ç½‘ç»œå®‰å…¨ç»„</li>
<li>ç½‘ç»œæ“ä½œå¿…é¡»ç®€å•å®‰å…¨ã€‚ç”¨æˆ·å¿…é¡»èƒ½å¤Ÿåº”ç”¨ç°æœ‰çš„AWS VPCç½‘ç»œå’Œå®‰å…¨æœ€ä½³å®è·µï¼Œä»¥é€šè¿‡AWS VPCæ„å»ºKubernetesé›†ç¾¤</li>
<li>åªéœ€å‡ ç§’é’Ÿå³å¯è®¾ç½®Podç½‘ç»œ</li>
<li>ç®¡ç†å‘˜åº”èƒ½å¤Ÿå°†ç¾¤é›†æ‰©å±•åˆ°2000ä¸ªèŠ‚ç‚¹</li>
</ul>
<h4 id="412-æ–¹æ¡ˆ">
  4.1.2 æ–¹æ¡ˆ
  <a class="heading-link" href="#412-%e6%96%b9%e6%a1%88">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<ul>
<li>ä¸ºæ¯ä¸ªNode(ec2)åˆ›å»ºå¤šä¸ªå¼¹æ€§ç½‘ç»œæ¥å£(ENIs)ï¼Œå¹¶åˆ†é…secondary IP</li>
<li>å¯¹äºæ¯ä¸ªPodï¼Œé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„secondary IPï¼Œå°†å…¶åˆ†é…ç»™Podï¼Œå¹¶å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š
<ul>
<li>åœ¨å•ä¸ªä¸»æœºä¸Šè¿›è¡ŒPodåˆ°Podçš„é€šä¿¡</li>
<li>åœ¨ä¸åŒä¸»æœºä¸Šè¿›è¡ŒPodåˆ°Podçš„é€šä¿¡</li>
<li>å…è®¸åœ¨Podå’ŒAWSæœåŠ¡è¿›è¡Œé€šä¿¡</li>
<li>å…è®¸Podå’Œæœ¬åœ°æ•°æ®ä¸­å¿ƒè¿›è¡Œé€šä¿¡</li>
<li>å…è®¸Podå’ŒInternetè¿›è¡Œé€šä¿¡</li>
</ul>
</li>
</ul>
<blockquote>
<p>åœ¨EC2-VPCé‡Œï¼Œæ¯ä¸ªå®ä¾‹å¯ä»¥åˆ›å»ºå¤šä¸ªENIï¼Œæ¯ä¸ªENIå¯ä»¥åˆ†é…å¤šä¸ªIPåœ°å€ã€‚ ä»»ä½•å‘å¾€è¿™äº›IPåœ°å€ä¹‹ä¸€çš„æ•°æ®åŒ…ï¼ŒEC2-VPCéƒ½ä¼šå°†è¯¥æ•°æ®åŒ…ä¼ é€’åˆ°å®ä¾‹ã€‚</p>
<p>ENIæ˜¯è™šæ‹Ÿç½‘ç»œæ¥å£ï¼Œæ‚¨å¯ä»¥å°†å…¶é™„åŠ åˆ°VPCä¸­çš„å®ä¾‹ã€‚ å°†ENIé™„åŠ åˆ°å®ä¾‹åï¼Œå°†åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ¥å£ã€‚ ä¸»ENI IPåœ°å€ä¼šè‡ªåŠ¨åˆ†é…ç»™è¯¥æ¥å£ã€‚ æ‰€æœ‰è¾…åŠ©åœ°å€å‡æœªåˆ†é…ï¼Œå¹¶ä¸”ç”±ä¸»æœºæ‰€æœ‰è€…å†³å®šå¦‚ä½•é…ç½®å®ƒä»¬ã€‚</p>
</blockquote>
<h4 id="413-æ¶æ„">
  4.1.3 æ¶æ„
  <a class="heading-link" href="#413-%e6%9e%b6%e6%9e%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p><strong>Pod to Pod</strong></p>
<p><img src="wire-network.png" alt="img"></p>
<hr>
<p><strong>Inside a Pod</strong></p>
<p>IP address</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># ip addr show</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#2aa198">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#2aa198">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
3: eth0@if173: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#2aa198">9001</span> qdisc noqueue state UP group default
    link/ether 6a:f3:a1:ff:38:a8 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#2aa198">0</span>
    inet 172.31.176.184/32 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre></div><p>route</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># ip route show</span>
default via 169.254.1.1 dev eth0
169.254.1.1 dev eth0 scope link
</code></pre></div><p>static arp</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># arp -a</span>
172-31-177-243.node-exporter.monitoring.svc.cluster.local <span style="color:#719e07">(</span>172.31.177.243<span style="color:#719e07">)</span> at 8e:6b:e1:80:7c:de <span style="color:#719e07">[</span>ether<span style="color:#719e07">]</span> on eth0
_gateway <span style="color:#719e07">(</span>169.254.1.1<span style="color:#719e07">)</span> at 8e:6b:e1:80:7c:de <span style="color:#719e07">[</span>ether<span style="color:#719e07">]</span> PERM on eth0
</code></pre></div><p><strong>On Host side</strong></p>
<p>ip address</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># ip addr show</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#2aa198">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#2aa198">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#2aa198">9001</span> qdisc mq state UP group default qlen <span style="color:#2aa198">1000</span>
    link/ether 02:b1:bf:9a:b2:cb brd ff:ff:ff:ff:ff:ff
    inet 172.31.177.243/23 brd 172.31.177.255 scope global dynamic eth0
       valid_lft 2539sec preferred_lft 2539sec
    inet6 fe80::b1:bfff:fe9a:b2cb/64 scope link
       valid_lft forever preferred_lft forever
8: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#2aa198">9001</span> qdisc mq state UP group default qlen <span style="color:#2aa198">1000</span>
    link/ether 02ğŸ’¿2d:55:75:29 brd ff:ff:ff:ff:ff:ff
    inet 172.31.177.128/23 brd 172.31.177.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80:ğŸ’¿2dff:fe55:7529/64 scope link
       valid_lft forever preferred_lft forever
173: enic614534eb15@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#2aa198">9001</span> qdisc noqueue state UP group default
    link/ether 8e:6b:e1:80:7c:de brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#2aa198">3</span>
    inet6 fe80::8c6b:e1ff:fe80:7cde/64 scope link
       valid_lft forever preferred_lft forever
</code></pre></div><p>é€šè¿‡è·¯ç”±è¡¨æ§åˆ¶Podçš„å‡ºå…¥æµé‡</p>
<ul>
<li>
<p>main routeæ§åˆ¶è¿›å…¥podçš„æµé‡</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># ip route show</span>
default via 172.31.176.1 dev eth0
169.254.169.254 dev eth0
172.31.176.0/23 dev eth0 proto kernel scope link src 172.31.177.243
172.31.176.184 dev enic614534eb15 scope link   <span style="color:#586e75"># &lt;----- Pod&#39;s IP </span>
</code></pre></div></li>
<li>
<p>æ¯ä¸ªENIéƒ½æœ‰è‡ªå·±çš„è·¯ç”±è¡¨ï¼Œè¯¥è·¯ç”±è¡¨ç”¨äºè·¯ç”±Podçš„ä¼ å‡ºæµé‡ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># ip route show table 2</span>
default via 172.31.176.1 dev eth1
172.31.176.1 dev eth1 scope link
</code></pre></div></li>
<li>
<p>éœ€è¦ç»™pod ipé…ç½®ç­–ç•¥è·¯ç”±ï¼Œå¦åˆ™æµé‡æ— æ³•èµ°åˆ°ENIçš„è·¯ç”±è¡¨</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#586e75"># ip rule list</span>
0:	from all lookup <span style="color:#b58900">local</span>
512:	from all to 172.31.176.184 lookup main  --&gt; åˆ°Podçš„æµé‡èµ°é»˜è®¤è·¯ç”±è¡¨
1024:	from all fwmark 0x80/0x80 lookup main
1536:	from 172.31.176.184 lookup <span style="color:#2aa198">2</span>            --&gt; ä»Podå‡ºæ¥çš„æµé‡èµ°ENIè‡ªå·±çš„è·¯ç”±è¡¨     
32766:	from all lookup main
32767:	from all lookup default
</code></pre></div></li>
</ul>
<h4 id="414-cniæ’ä»¶æ‰§è¡Œçš„æ“ä½œ">
  4.1.4 CNIæ’ä»¶æ‰§è¡Œçš„æ“ä½œ
  <a class="heading-link" href="#414-cni%e6%8f%92%e4%bb%b6%e6%89%a7%e8%a1%8c%e7%9a%84%e6%93%8d%e4%bd%9c">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<ul>
<li>
<p>åˆ›å»ºveth pairï¼Œä¸€ä¸ªæ”¾åˆ°ä¸»æœºçš„namespaceï¼Œä¸€ä¸ªæ”¾åˆ°Podâ€™s namespace</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">ip link add veth-1 type veth peer name veth-1c  /* on host namespace <span style="font-style:italic">*/
</span><span style="font-style:italic">ip link set veth-1c netns ns1  /*</span> move veth-1c to Pod&#39;s namespace ns1 <span style="font-style:italic">*/
</span><span style="font-style:italic">ip link set veth-1 up /*</span> bring up veth-1 <span style="font-style:italic">*/
</span><span style="font-style:italic">ip netns exec ns1 ip link set veth-1c up /*</span> bring up veth-1c */
</code></pre></div></li>
<li>
<p>è·å–åˆ†é…ç»™å®ä¾‹çš„secondary IPåœ°å€ï¼Œå¹¶åœ¨Podçš„namespaceä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>åˆ†é…IPç»™Podçš„eth0</li>
<li>æ·»åŠ é»˜è®¤ç½‘å…³å’Œé»˜è®¤è·¯ç”±åˆ°Podçš„è·¯ç”±è¡¨</li>
<li>ç»™é»˜è®¤ç½‘å…³æ·»åŠ é™æ€ARPæ¡ç›®</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">/* To assign IP address 172.31.176.184 to Pod&#39;s namespace ns1 <span style="font-style:italic">*/
</span><span style="font-style:italic"> ip netns exec ns1 ip addr add 172.31.176.184/32 dev veth-1c /*</span> assign a IP address to veth-1c <span style="font-style:italic">*/
</span><span style="font-style:italic"> ip netns exec ns1 ip route add 169.254.1.1 dev veth-1c /*</span> add default gateway <span style="font-style:italic">*/ 
</span><span style="font-style:italic"> ip netns exec ns1 ip route add default via 169.254.1.1 dev veth-1c /*</span> add default route <span style="font-style:italic">*/
</span><span style="font-style:italic">    
</span><span style="font-style:italic"> ip netns exec ns1 arp -i veth-1c -s 169.254.1.1 &lt;veth-1&#39;s mac&gt; /*</span> add static ARP entry for default gateway */
</code></pre></div></li>
<li>
<p>åœ¨ä¸»æœºä¸Šæ·»åŠ åˆ°Podçš„è·¯ç”±</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">/* Pod&#39;s IP address is 172.31.176.184 <span style="font-style:italic">*/
</span><span style="font-style:italic"> ip route add 172.31.176.184/32 dev veth-1 /*</span> add host route */
</code></pre></div></li>
</ul>
<h4 id="415-æµé‡è¿‡ç¨‹">
  4.1.5 æµé‡è¿‡ç¨‹
  <a class="heading-link" href="#415-%e6%b5%81%e9%87%8f%e8%bf%87%e7%a8%8b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown"><span style="color:#cb4b16">#ä»¥172.31.176.184ä¸ºä¾‹è¯´æ˜node1&#39;s pod1 to node2&#39;s pod2çš„æµé‡å‘å‡ºè¿‡ç¨‹
</span><span style="color:#cb4b16"></span><span style="color:#719e07">1.</span> pod1çš„é»˜è®¤å‡ºå£ä¸º169.254.1.1(macåœ°å€ä¸ºveth pairçš„å¦ä¸€ç«¯)
<span style="color:#719e07">2.</span> åŒ¹é…ç­–ç•¥è·¯ç”±from 172.31.176.184 lookup 2
<span style="color:#719e07">3.</span> åŒ¹é…è·¯ç”±è¡¨2 default via 172.31.176.1 dev eth1ï¼Œæµé‡ä»node1çš„eth1å‡ºå£å‡ºå»
<span style="color:#719e07">4.</span> EC2-VPCæµé‡è½¬å‘åˆ°node2çš„ethX

<span style="color:#cb4b16">#é€šè¿‡172.31.176.184ä¸ºä¾‹è§£é‡Šnode2&#39;s pod2çš„æ¥æ”¶è¿‡ç¨‹
</span><span style="color:#cb4b16"></span><span style="color:#719e07">5.</span> æµé‡è¿›å…¥node2çš„eth1æ¥å£
<span style="color:#719e07">6.</span> åŒ¹é…ç­–ç•¥è·¯ç”±from all to 172.31.176.184 lookup main
<span style="color:#719e07">7.</span> åŒ¹é…è·¯ç”±è¡¨main 172.31.176.184 dev enic614534eb15 scope link,æµé‡å‘å¾€enic614534eb15æ¥å£
<span style="color:#719e07">8.</span> é€šè¿‡veth pairä¼ è¾“ç»™pod2
</code></pre></div><p><strong>Pod To Pod</strong></p>
<p><img src="pod-pod.png" alt=""></p>
<p>**Pod To External **</p>
<p><img src="https://cctrip.github.io/notes/docs/technology/cloud/container/kubernetes/network/aws/pod-external.png" alt="img"></p>
<p><strong>AWS_VPC_K8S_CNI_EXTERNALSNAT = False</strong></p>
<p>ä½¿ç”¨iptables SNATè§„åˆ™ï¼Œå°†pod ipè½¬æ¢æˆä¸»ENIçš„ä¸»IPåœ°å€</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">-A POSTROUTING ! -d &lt;VPC-CIDR&gt; -m comment --comment &#34;kubenetes: SNAT for outbound traffic from cluster&#34; -m addrtype ! --dst-typ
</code></pre></div><p><strong>AWS_VPC_K8S_CNI_EXTERNALSNAT = True</strong></p>
<p>å½“å°†SNATåŠŸèƒ½å…³é—­åï¼Œæ— æ³•é€šè¿‡ä¸»ENIçš„ä¸»IPåœ°å€åšå¤–ç½‘æ˜ å°„ï¼Œæ­¤æ—¶éœ€è¦ç»™å¯¹åº”çš„ENIçš„ä¸»IPåœ°å€é…ç½®å¯¹åº”çš„å¤–ç½‘IPï¼Œæˆ–è€…ç»™å­ç½‘é…ç½®é»˜è®¤ç½‘å…³</p>
<hr>
<h2 id="5-ç»“è®º">
  5. ç»“è®º
  <a class="heading-link" href="#5-%e7%bb%93%e8%ae%ba">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>è¯¥ç¯‡æˆ‘ä»¬äº†è§£äº†k8sç½‘ç»œçš„å®ç°æ–¹å¼ï¼Œä»¥åŠCNIæ’ä»¶å…·å¤‡çš„åŠŸèƒ½ï¼Œå¹¶äº†è§£äº†ä¸€äº›ä¸»æµçš„CNIç½‘ç»œæ–¹æ¡ˆã€‚</p>
<hr>
<p><strong>å‚è€ƒ</strong></p>
<p><a href="https://github.com/containernetworking/cni">https://github.com/containernetworking/cni</a></p>
<p><a href="https://sookocheff.com/post/kubernetes/understanding-kubernetes-networking-model/">https://sookocheff.com/post/kubernetes/understanding-kubernetes-networking-model/</a></p>
<p><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md</a></p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    Â©
    
      2019 -
    
    2021
     Hello.CC 
    Â·
    Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">CCoder</a>.
    
  </section>
</footer>

    </main>

    
      
      <script src="/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js" integrity="sha256-A7F3afT5GuNWZ&#43;HyocqMFvUFYlds&#43;Q/zKzF5kmkU2qU="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
